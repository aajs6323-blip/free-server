name: Ubuntu 22.04 SSH via Ngrok (Direct Download)

on: [push]

jobs:
  ssh-setup:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    
    # 1. تثبيت SSH وتفعيل الخدمة
    - name: Setup SSH Server
      run: |
        echo "Installing OpenSSH server..."
        sudo apt-get update
        sudo apt-get install openssh-server wget unzip jq -y # أضفنا wget و unzip و jq
        sudo systemctl enable ssh
        sudo systemctl start ssh

    # 2. إنشاء مستخدم SSH وكلمة مرور
    - name: Create SSH User
      run: |
        USER="ubuntuuser"
        # ⚠️ استخدم كلمة مرور قوية ومعقدة هنا!
        PASSWORD="UbntSsh@2025!" 
        
        echo "Creating user $USER..."
        sudo useradd -m -s /bin/bash $USER
        echo "$USER:$PASSWORD" | sudo chpasswd
        sudo usermod -aG sudo $USER
        
        echo "::notice::SSH user $USER created successfully."
        
    # 3. تنزيل وتثبيت Ngrok (الطريقة المباشرة والأكثر موثوقية)
    - name: Download and install Ngrok
      run: |
        echo "Downloading and installing Ngrok..."
        # تنزيل الملف المضغوط باستخدام رابط ثابت
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip -O ngrok.zip
        # فك الضغط (ينتج الملف القابل للتنفيذ ngrok)
        unzip ngrok.zip
        # إزالة الملف المضغوط
        rm ngrok.zip
        
    # 4. مصادقة Ngrok باستخدام الـ Secret
    - name: Authenticate Ngrok
      # نستخدم المسار المباشر للملف الذي تم فك ضغطه
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      
    # 5. بدء Ngrok و طباعة معلومات الاتصال
    - name: Start Ngrok and display connection info
      run: |
        # بدء نفق TCP على المنفذ 22 (منفذ SSH) في الخلفية باستخدام الملف المباشر
        ./ngrok tcp 22 --log=stdout &

        sleep 10
        
        # استرداد عنوان النفق
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')

        if [ -z "$TUNNEL_URL" ]; then
          echo "::error::Failed to establish Ngrok tunnel"
          exit 1
        fi
        
        # إزالة بادئة tcp:// للحصول على العنوان:المنفذ
        HOST_PORT=$(echo "$TUNNEL_URL" | sed 's/tcp:\/\///')
        
        # عرض البيانات
        echo "=========================================="
        echo "||       SSH CONNECTION DETAILS         ||"
        echo "=========================================="
        echo "Address (Host:Port): $HOST_PORT"
        echo "Username: ubuntuuser"
        echo "Password: UbntSsh@2025!"
        echo "------------------------------------------"
        echo "SSH Command: ssh ubuntuuser@$HOST_PORT"
        echo "=========================================="
        
        while true; do
            sleep 300
        done
        
    # 6. خطوة تنظيف إجبارية
    - name: Force cleanup
      if: always()
      run: |
        pkill ngrok || true
