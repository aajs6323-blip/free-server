name: Ubuntu Desktop with noVNC and Ngrok Tunnel

on:
  workflow_dispatch: # يسمح بالتشغيل اليدوي من واجهة GitHub

jobs:
  run-desktop:
    runs-on: ubuntu-latest # يعمل على أحدث إصدار من Ubuntu
    timeout-minutes: 360 # 6 ساعات حد أقصى

    steps:
    - name: Install dependencies (Desktop, VNC, noVNC tools)
      run: |
        echo "Installing Desktop and VNC dependencies..."
        # تثبيت سطح المكتب (XFCE4)، VNC، وأدوات التنزيل
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver git curl wget unzip jq openssh-client
        # تثبيت أدوات noVNC
        sudo apt install -y python3 python3-pip
        pip3 install websockify

    - name: Setup VNC server and noVNC
      run: |
        echo "Setting up VNC server..."
        # 1. إعداد كلمة مرور لـ VNC
        mkdir -p ~/.vnc
        echo "123456" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

        # 2. إعداد ملف تشغيل سطح المكتب (xstartup)
        echo '#!/bin/bash
        xrdb $HOME/.Xresources
        startxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup

        # 3. بدء VNC لضبط الإعدادات
        vncserver :1 -geometry 1280x720 -depth 24
        vncserver -kill :1
        vncserver :1 -geometry 1280x720 -depth 24

        # 4. تنزيل noVNC
        git clone https://github.com/novnc/noVNC.git ~/noVNC
        git clone https://github.com/novnc/websockify.git ~/noVNC/utils/websockify

    - name: Run noVNC server (on port 6080)
      run: |
        # تشغيل noVNC لتحويل VNC (5901) إلى WebSocket (6080)
        echo "Starting noVNC on port 6080..."
        nohup ~/noVNC/utils/launch.sh --vnc localhost:5901 --listen 6080 &
        
    # 4. تثبيت Ngrok (الطريقة المباشرة الموثوقة)
    - name: Download and install Ngrok
      run: |
        echo "Downloading and installing Ngrok..."
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip -O ngrok.zip
        unzip ngrok.zip
        rm ngrok.zip
        
    # 5. مصادقة Ngrok
    - name: Authenticate Ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      
    # 6. بدء Ngrok و طباعة معلومات الاتصال
    - name: Start Ngrok and display connection info
      run: |
        # بدء نفق TCP لمنفذ noVNC (6080)
        echo "Starting Ngrok tunnel..."
        ./ngrok tcp 6080 --log=stdout &

        # انتظار النفق للإنشاء
        sleep 15
        
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')

        if [ -z "$TUNNEL_URL" ]; then
          echo "::error::Failed to establish Ngrok tunnel"
          exit 1
        fi
        
        HOST_PORT=$(echo "$TUNNEL_URL" | sed 's/tcp:\/\///')

        echo "=========================================="
        echo "||    VNC DESKTOP CONNECTION DETAILS    ||"
        echo "=========================================="
        echo "VNC Password: 123456"
        echo "Connection Address: $HOST_PORT"
        echo "------------------------------------------"
        echo "Instructions:"
        # 1. افتح العنوان كـ HTTP في المتصفح
        echo "1. Open this URL in your browser: http://$HOST_PORT"
        # 2. العنوان المستهدف هو VNC
        echo "2. In the noVNC page, connect to: localhost:5901"
        # 3. كلمة مرور VNC
        echo "3. Enter password 123456 when prompted."
        echo "=========================================="
        
        # إبقاء الـ Job حياً
        while true; do
            sleep 300
        done
            
    # 7. خطوة تنظيف إجبارية
    - name: Force cleanup
      if: always()
      run: |
        pkill ngrok || true
        pkill Xtightvnc || true
