name: Ubuntu SSH via Ngrok (Germany EU Region)

on: [push]

jobs:
  ssh-setup:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    
    # 1. ØªØ«Ø¨ÙŠØª SSH ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
    - name: Setup SSH Server
      run: |
        echo "Installing OpenSSH server..."
        sudo apt-get update
        sudo apt-get install openssh-server wget unzip jq -y
        sudo systemctl enable ssh
        sudo systemctl start ssh

    # 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… SSH ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
    - name: Create SSH User
      run: |
        USER="ubuntuuser"
        # âš ï¸ Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ© ÙˆÙ…Ø¹Ù‚Ø¯Ø©
        PASSWORD="UbntSsh@2025!" 
        
        echo "Creating user $USER..."
        sudo useradd -m -s /bin/bash $USER
        echo "$USER:$PASSWORD" | sudo chpasswd
        sudo usermod -aG sudo $USER
        
        echo "::notice::SSH user $USER created successfully."
        
    # 3. ØªÙ†Ø²ÙŠÙ„ ÙˆØªØ«Ø¨ÙŠØª Ngrok
    - name: Download and install Ngrok
      run: |
        echo "Downloading and installing Ngrok..."
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip -O ngrok.zip
        unzip ngrok.zip
        rm ngrok.zip
        
    # 4. Ù…ØµØ§Ø¯Ù‚Ø© Ngrok Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Secret
    - name: Authenticate Ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      
    # 5. Ø¨Ø¯Ø¡ Ngrok Ùˆ Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
    - name: Start Ngrok and display connection info
      run: |
        # ğŸŒŸ ØªÙ… Ø¥Ø¶Ø§ÙØ© --region eu Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù†ÙÙ‚ Ø¥Ù„Ù‰ Ø®ÙˆØ§Ø¯Ù… Ø£Ù„Ù…Ø§Ù†ÙŠØ§/Ø£ÙˆØ±ÙˆØ¨Ø§
        ./ngrok tcp 22 --region eu --log=stdout & 

        sleep 10
        
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')

        if [ -z "$TUNNEL_URL" ]; then
          echo "::error::Failed to establish Ngrok tunnel"
          exit 1
        fi
        
        HOST_PORT=$(echo "$TUNNEL_URL" | sed 's/tcp:\/\///')
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        echo "=========================================="
        echo "||       SSH CONNECTION DETAILS (DE)    ||"
        echo "=========================================="
        echo "Address (Host:Port): $HOST_PORT"
        echo "Username: ubuntuuser"
        echo "Password: UbntSsh@2025!"
        echo "------------------------------------------"
        echo "SSH Command: ssh ubuntuuser@$HOST_PORT"
        echo "=========================================="
        
        while true; do
            sleep 300
        done
        
    # 6. Ø®Ø·ÙˆØ© ØªÙ†Ø¸ÙŠÙ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
    - name: Force cleanup
      if: always()
      run: |
        pkill ngrok || true
