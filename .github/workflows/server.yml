name: Ubuntu 22.04 SSH via Ngrok

on: [push]

jobs:
  ssh-setup:
    # ุชุญุฏูุฏ ุงูุฅุตุฏุงุฑ Ubuntu 22.04 LTS
    runs-on: ubuntu-22.04
    # ุงูุญุฏ ุงูุฃูุตู ููุชุดุบูู
    timeout-minutes: 360

    steps:
    
    # 1. ุชุซุจูุช SSH ูุชูุนูู ุงูุฎุฏูุฉ
    - name: Setup SSH Server
      run: |
        echo "Installing OpenSSH server..."
        sudo apt-get update
        sudo apt-get install openssh-server -y
        sudo systemctl enable ssh
        sudo systemctl start ssh

    # 2. ุฅูุดุงุก ูุณุชุฎุฏู SSH ููููุฉ ูุฑูุฑ
    - name: Create SSH User
      run: |
        USER="ubuntuuser"
        # โ๏ธ ุงุณุชุฎุฏู ูููุฉ ูุฑูุฑ ูููุฉ ููุนูุฏุฉ ููุง!
        PASSWORD="UbntSsh@2025!" 
        
        echo "Creating user $USER..."
        sudo useradd -m -s /bin/bash $USER
        echo "$USER:$PASSWORD" | sudo chpasswd
        sudo usermod -aG sudo $USER
        
        echo "::notice::SSH user $USER created successfully."
        
    # 3. ุชุซุจูุช Ngrok (ุงูุทุฑููุฉ ุงูุฑุณููุฉ ูู v3 ูุงููุตุญุญุฉ)
    - name: Install Ngrok (Official v3 Method)
      run: |
        echo "Installing Ngrok v3..."
        
        # ุฅุถุงูุฉ ููุชุงุญ ุงูุฃูุงู ูู Ngrok
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        
        # ๐ ุงูุชุตุญูุญ: ุชู ุชุบููุฑ 'focal' ุฅูู 'jammy' ููุชูุงูู ูุน Ubuntu 22.04
        echo "deb https://ngrok-agent.s3.amazonaws.com jammy main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        
        # ุชุญุฏูุซ ูุชุซุจูุช
        sudo apt update
        sudo apt install ngrok -y
        
    # 4. ูุตุงุฏูุฉ Ngrok ุจุงุณุชุฎุฏุงู ุงูู Secret
    - name: Authenticate Ngrok
      run: ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      
    # 5. ุจุฏุก Ngrok ู ุทุจุงุนุฉ ูุนูููุงุช ุงูุงุชุตุงู
    - name: Start Ngrok and display connection info
      run: |
        # ุจุฏุก ููู TCP ุนูู ุงููููุฐ 22 (ูููุฐ SSH) ูู ุงูุฎูููุฉ
        ngrok tcp 22 --log=stdout &

        # ุงูุงูุชุธุงุฑ ูุถูุงู ุฅูุดุงุก ุงูููู
        sleep 10
        
        # ุงูุชุฃูุฏ ูู ุชุซุจูุช jq ูุจู ุงูุงุณุชุฎุฏุงู
        sudo apt-get install jq -y
        
        # ุงุณุชุฑุฏุงุฏ ุนููุงู ุงูููู ูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช Ngrok
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')

        if [ -z "$TUNNEL_URL" ]; then
          echo "::error::Failed to establish Ngrok tunnel"
          exit 1
        fi
        
        # ุฅุฒุงูุฉ ุจุงุฏุฆุฉ tcp:// ููุญุตูู ุนูู ุงูุนููุงู:ุงููููุฐ
        HOST_PORT=$(echo "$TUNNEL_URL" | sed 's/tcp:\/\///')
        
        # ุนุฑุถ ุงูุจูุงูุงุช
        echo "=========================================="
        echo "||       SSH CONNECTION DETAILS         ||"
        echo "=========================================="
        echo "Address (Host:Port): $HOST_PORT"
        echo "Username: ubuntuuser"
        echo "Password: UbntSsh@2025!" # ุชุฃูุฏ ูู ุงุณุชุฎุฏุงู ูููุฉ ุงููุฑูุฑ ุงูุชู ุงุฎุชุฑุชูุง
        echo "------------------------------------------"
        echo "SSH Command: ssh ubuntuuser@$HOST_PORT"
        echo "=========================================="
        
        # ุฅุจูุงุก ุงูู Job ุญูุงู ููุฏุฉ 6 ุณุงุนุงุช
        while true; do
            sleep 300
        done
        
    # 6. ุฎุทูุฉ ุชูุธูู ุฅุฌุจุงุฑูุฉ
    - name: Force cleanup
      if: always()
      run: |
        pkill ngrok || true
