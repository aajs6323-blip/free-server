name: Ubuntu 22.04 SSH via Ngrok

on: [push]

jobs:
  ssh-setup:
    # تحديد الإصدار Ubuntu 22.04 LTS
    runs-on: ubuntu-22.04
    # الحد الأقصى للتشغيل
    timeout-minutes: 360

    steps:
    
    # 1. تثبيت SSH وتفعيل الخدمة
    - name: Setup SSH Server
      run: |
        echo "Installing OpenSSH server..."
        sudo apt-get update
        sudo apt-get install openssh-server -y
        sudo systemctl enable ssh
        sudo systemctl start ssh

    # 2. إنشاء مستخدم SSH وكلمة مرور
    - name: Create SSH User
      run: |
        USER="ubuntuuser"
        # ⚠️ استخدم كلمة مرور قوية ومعقدة هنا!
        PASSWORD="UbntSsh@2025!" 
        
        echo "Creating user $USER..."
        sudo useradd -m -s /bin/bash $USER
        echo "$USER:$PASSWORD" | sudo chpasswd
        sudo usermod -aG sudo $USER
        
        echo "::notice::SSH user $USER created successfully."
        
    # 3. تثبيت Ngrok (الطريقة الرسمية لـ v3)
    - name: Install Ngrok (Official v3 Method)
      run: |
        echo "Installing Ngrok v3..."
        # إضافة مفتاح الأمان لـ Ngrok
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        # إضافة مستودع Ngrok
        echo "deb https://ngrok-agent.s3.amazonaws.com focal main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        # تحديث وتثبيت
        sudo apt update
        sudo apt install ngrok -y
        
    # 4. مصادقة Ngrok باستخدام الـ Secret
    - name: Authenticate Ngrok
      # نستخدم 'ngrok' مباشرة لأنه تم تثبيته كأمر نظام
      run: ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      
    # 5. بدء Ngrok و طباعة معلومات الاتصال
    - name: Start Ngrok and display connection info
      run: |
        # بدء نفق TCP على المنفذ 22 (منفذ SSH) في الخلفية
        ngrok tcp 22 --log=stdout &

        # الانتظار لضمان إنشاء النفق
        sleep 10
        
        # التأكد من تثبيت jq قبل الاستخدام
        sudo apt-get install jq -y
        
        # استرداد عنوان النفق من واجهة برمجة تطبيقات Ngrok
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')

        if [ -z "$TUNNEL_URL" ]; then
          echo "::error::Failed to establish Ngrok tunnel"
          exit 1
        fi
        
        # إزالة بادئة tcp://
        HOST_PORT=$(echo "$TUNNEL_URL" | sed 's/tcp:\/\///')
        
        # عرض البيانات
        echo "=========================================="
        echo "||       SSH CONNECTION DETAILS         ||"
        echo "=========================================="
        echo "Address (Host:Port): $HOST_PORT"
        echo "Username: ubuntuuser"
        echo "Password: UbntSsh@2025!" # تأكد من استخدام كلمة المرور التي اخترتها
        echo "------------------------------------------"
        echo "SSH Command: ssh ubuntuuser@$HOST_PORT"
        echo "=========================================="
        
        # إبقاء الـ Job حياً لمدة 6 ساعات
        while true; do
            sleep 300
        done
        
    # 6. خطوة تنظيف إجبارية
    - name: Force cleanup
      if: always()
      run: |
        pkill ngrok || true
